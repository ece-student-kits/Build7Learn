"use strict";(globalThis.webpackChunkstm_32_documentaion=globalThis.webpackChunkstm_32_documentaion||[]).push([[3645],{9175(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"STM32/UltrasonicSensor/code","title":"Code","description":"Task: To interface ultrasonic sensor with STM32","source":"@site/docs/STM32/UltrasonicSensor/code.md","sourceDirName":"STM32/UltrasonicSensor","slug":"/STM32/UltrasonicSensor/code","permalink":"/Build7Learn/docs/STM32/UltrasonicSensor/code","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/STM32/UltrasonicSensor/code.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"HC-SR04","permalink":"/Build7Learn/docs/STM32/UltrasonicSensor/"},"next":{"title":"RoomAutomation","permalink":"/Build7Learn/docs/STM32/CustomProjects/RoomAutomation"}}');var t=s(4848),c=s(8453);const r={},o="Code",l={},d=[{value:"Step 1: Create a STM32 Project &quot;Ultrasonic&quot;",id:"step-1-create-a-stm32-project-ultrasonic",level:3},{value:"Step 2: Clock Configuration",id:"step-2-clock-configuration",level:3},{value:"Step 3: Pinout &amp; Configuration",id:"step-3-pinout--configuration",level:3},{value:"Step 4: Code Snippet to measure distance using ultrasonic sensor and display in the 16x2 LCD Display",id:"step-4-code-snippet-to-measure-distance-using-ultrasonic-sensor-and-display-in-the-16x2-lcd-display",level:3}];function a(e){const n={code:"code",h1:"h1",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"code",children:"Code"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"Task: To interface ultrasonic sensor with STM32"})}),"\n",(0,t.jsx)(n.h3,{id:"step-1-create-a-stm32-project-ultrasonic",children:'Step 1: Create a STM32 Project "Ultrasonic"'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-2-clock-configuration",children:"Step 2: Clock Configuration"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Image",src:s(6682).A+"",width:"1091",height:"297"})}),"\n",(0,t.jsxs)(n.p,{children:["You can specify your ",(0,t.jsx)(n.code,{children:"System clock"}),". We will set ",(0,t.jsx)(n.code,{children:"HCLK (MHz)"})," as ",(0,t.jsx)(n.strong,{children:"180 MHz"})," and press 'ENTER'. And generate the code and associated perspectives by saving using CTRL + S."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-3-pinout--configuration",children:"Step 3: Pinout & Configuration"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Image",src:s(6849).A+"",width:"429",height:"390"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Configure system clock:\nSystem Core > ",(0,t.jsx)(n.code,{children:"RCC"})," then select \u2018",(0,t.jsx)(n.code,{children:"Crystal/Ceramic Resonator"}),"\u2019 in from the High Speed Clock(",(0,t.jsx)(n.code,{children:"HSC"}),") feature"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Now configure ",(0,t.jsx)(n.code,{children:"I2C"})," by following the procedure in 16x2 LCD tutorial or by following the step below.\n(",(0,t.jsx)(n.strong,{children:"DON'T FORGET TO ADD THE NECESSARY LIBRARY FILES FOR I2C_LCD"}),")"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Image",src:s(7814).A+"",width:"427",height:"438"})}),"\n",(0,t.jsxs)(n.p,{children:["(Under Pinout& Configuration- Connectivity > I2C1.\nSelect the ",(0,t.jsx)(n.code,{children:"I2C mode"})," as \u2018",(0,t.jsx)(n.strong,{children:"I2C"}),"\u2019\nThen go to \u2018Parameter Settings\u2019 and set the",(0,t.jsx)(n.code,{children:"I2C speed mode"})," as \u2018",(0,t.jsx)(n.strong,{children:"Fast Mode"}),"\u2019)"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Image",src:s(4259).A+"",width:"676",height:"561"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Now head over to ",(0,t.jsx)(n.code,{children:"Timers > TIM1"})," and select the Clock Source as \u2018",(0,t.jsx)(n.code,{children:"Internal Clock"}),".\u2019 Then click the Parameter Settings and set the ",(0,t.jsx)(n.code,{children:"Prescaler"})," as ",(0,t.jsx)(n.strong,{children:"180-1"})," and ",(0,t.jsx)(n.code,{children:"Counter period"})," as ",(0,t.jsx)(n.strong,{children:"65536-1"})," as it is the maximum value for a 16 bit timer (default)."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Image",src:s(4092).A+"",width:"681",height:"526"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Now configure GPIO Pins:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"PA10"})," as ",(0,t.jsx)(n.code,{children:"GPIO_OUTPUT"})," (TRIGGER PIN [D2])"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"PA4"})," as ",(0,t.jsx)(n.code,{children:"GPIO_INPUT"})," (ECHO PIN [A2])"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note1:"}),"\nBesure to change the Prescalar value as per your system clock."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["we do this to get a ",(0,t.jsx)(n.code,{children:"1us"})," pulse"]}),"\n",(0,t.jsxs)(n.li,{children:["Example:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"System clock = 180"}),"\n",(0,t.jsx)(n.li,{children:"Prescalar Value = 180-1"}),"\n",(0,t.jsx)(n.li,{children:"Pulse = 180Mhz/180\n= 1Mhz"}),"\n",(0,t.jsx)(n.li,{children:"Timeperiod = 1/freq\n= 1/1Mhz\n= 1us"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note2:"}),"\nReg counter period, ",(0,t.jsx)(n.strong,{children:"65536-1"})," is the max value for 16 bit timer, but for this code we can use any value greater than ",(0,t.jsx)(n.strong,{children:"10"}),".\nBut max value is preffered to avoid confusion."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-4-code-snippet-to-measure-distance-using-ultrasonic-sensor-and-display-in-the-16x2-lcd-display",children:"Step 4: Code Snippet to measure distance using ultrasonic sensor and display in the 16x2 LCD Display"}),"\n",(0,t.jsxs)(n.p,{children:["Paste the following code snippet inside the ",(0,t.jsx)(n.code,{children:"/* USER CODE BEGIN Includes */"})," in ",(0,t.jsx)(n.code,{children:"main.c"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'#include "stdio.h"\n#include "liquidcrystal_i2c.h"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Paste the following code snippet inside the ",(0,t.jsx)(n.code,{children:"/* USER CODE BEGIN PD */"})," in ",(0,t.jsx)(n.code,{children:"main.c"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"#define TRIG_PIN GPIO_PIN_10\n#define TRIG_PORT GPIOA\n#define ECHO_PIN GPIO_PIN_4\n#define ECHO_PORT GPIOA\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Paste the following code snippet inside the ",(0,t.jsx)(n.code,{children:"/* USER CODE BEGIN PV */"})," in ",(0,t.jsx)(n.code,{children:"main.c"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"uint32_t pMillis;\nuint32_t val1 = 0;\nuint32_t val2 = 0;\nuint16_t distance  = 0;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Paste the following code snippet inside the ",(0,t.jsx)(n.code,{children:"/* USER CODE BEGIN 2 */"})," in ",(0,t.jsx)(n.code,{children:"main.c"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"HAL_TIM_Base_Start(&htim1);\nHAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_RESET);\nLCD_Init(2);\nLCD_Clear();\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Paste the following code snippet inside the ",(0,t.jsx)(n.code,{children:"while (1)"})," in ",(0,t.jsx)(n.code,{children:"main.c"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'HAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_SET);\n__HAL_TIM_SET_COUNTER(&htim1, 0);\nwhile (__HAL_TIM_GET_COUNTER (&htim1) < 10);  // wait for 10 us\nHAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_RESET);\n\npMillis = HAL_GetTick();\nwhile (!(HAL_GPIO_ReadPin (ECHO_PORT, ECHO_PIN)) && pMillis + 10 >  HAL_GetTick());\nval1 = __HAL_TIM_GET_COUNTER (&htim1);\n\npMillis = HAL_GetTick();\nwhile ((HAL_GPIO_ReadPin (ECHO_PORT, ECHO_PIN)) && pMillis + 50 > HAL_GetTick());\nval2 = __HAL_TIM_GET_COUNTER (&htim1);\n\ndistance = (val2-val1)* 0.034/2;\n\nLCD_Clear();\nLCD_SetCursor(0,0);\nchar value[20];\nsprintf(value, "Distance: %dCm", distance);  // Format the string with the distance value\nLCD_Print(value);  // Pass the formatted string to the function\nHAL_Delay(500);\n'})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},6849(e,n,s){s.d(n,{A:()=>i});const i=s.p+"assets/images/1-75e9067153de5d03ce746a6a0b2bb946.png"},6682(e,n,s){s.d(n,{A:()=>i});const i=s.p+"assets/images/2-05721da51aa7270e14ab77bce16b09f3.png"},4259(e,n,s){s.d(n,{A:()=>i});const i=s.p+"assets/images/3-e9536a0b6dac274907b6df417a241bee.png"},4092(e,n,s){s.d(n,{A:()=>i});const i=s.p+"assets/images/4-26ee86566add8982816efcdd1dd5fefe.png"},7814(e,n,s){s.d(n,{A:()=>i});const i=s.p+"assets/images/5-d026b6fc1709eb834e2dbc0c2e69b0ac.webp"},8453(e,n,s){s.d(n,{R:()=>r,x:()=>o});var i=s(6540);const t={},c=i.createContext(t);function r(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);